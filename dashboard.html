<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam System - Secure Login</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4c51bf">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --indigo-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg: #f3f4f6;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: url('login-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        body.dashboard-active {
            background-image: none !important;
            background-color: var(--bg) !important;
            justify-content: flex-start;
            height: auto;
        }

        body.dashboard-active::before {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
        }

        .card {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        #screen-role .card {
            border-top: 5px solid hsla(171, 14%, 90%, 0.877);
        }

        .indigo-btn {
            background: var(--indigo-grad);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 10px;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .indigo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9rem;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            font-size: 1rem;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-link {
            background: none;
            color: var(--accent);
            margin-top: 15px;
            display: inline-block;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Dashboard Header */
        .dash-header {
            width: 90%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            margin-top: 30px;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 90%;
            max-width: 900px;
        }

        .nav-item {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-decoration: none;
            color: var(--primary);
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: 0.3s;
            border: 2px solid transparent;
            display: block;
        }

        .nav-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .nav-icon {
            font-size: 40px;
            color: var(--accent);
            margin-bottom: 15px;
        }

        .error-msg {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        /* --- ADMIN PANEL --- */
        #admin-panel {
            width: 90%;
            max-width: 900px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            display: none;
            margin-bottom: 50px;
            border: 2px solid #f39c12;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .panel-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--primary);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .user-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }

        .user-row:last-child {
            border-bottom: none;
        }

        .user-info strong {
            color: var(--primary);
            display: block;
        }

        .user-info small {
            color: #666;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-approve:hover {
            background: #219150;
        }

        .user-list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .user-list-table th,
        .user-list-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
            vertical-align: middle;
        }

        .user-list-table th {
            background: #f8f9fa;
            color: #555;
        }

        .badge-official {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .badge-individual {
            background: #f3f4f6;
            color: #374151;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .badge-admin {
            background: #fef3c7;
            color: #d97706;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #fcd34d;
        }

        .pass-reveal {
            font-family: monospace;
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            color: #c0392b;
        }

        .action-btn {
            padding: 5px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
            margin-right: 3px;
            width: 30px;
            height: 30px;
        }

        .btn-edit {
            background: #3498db;
        }

        .btn-del {
            background: #e74c3c;
        }

        .btn-make-admin {
            background: #f39c12;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        #btn-show-panel {
            display: none;
            margin-top: 20px;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .auth-footer {
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div id="screen-role" class="auth-container fade-in">
        <div class="card">
            <img src="ME PNG.png" alt="Logo" style="width: 120px; margin-bottom: 15px;">
            <h2 style="color:#4c1d95;">Welcome</h2>
            <p style="color:#666; margin-bottom:30px;">Select your role to proceed</p>
            <button class="indigo-btn" onclick="selectRole('official')"><i class="fas fa-user-shield"></i> Official
                Login</button>
            <button class="indigo-btn" style="background: white; color: #4c1d95; border: 2px solid #4c1d95;"
                onclick="selectRole('individual')"><i class="fas fa-user"></i> Individual Login</button>
        </div>
    </div>

    <div id="screen-code" class="auth-container hidden">
        <div class="card">
            <h2>Security Check</h2>
            <p>Please enter the official unique code.</p>
            <div class="form-group">
                <input type="password" id="official-code" placeholder="Enter Code">
                <div id="code-error" class="error-msg">Invalid Code! Access Denied.</div>
            </div>
            <button class="btn btn-primary" onclick="verifyCode()">Verify</button>
            <span class="btn-link" onclick="showScreen('screen-role')">Back</span>
        </div>
    </div>

    <div id="screen-auth" class="auth-container hidden">
        <div id="login-form">
            <div class="card">
                <h2 id="auth-title">Login</h2>
                <div class="form-group"><label>User ID</label><input type="text" id="login-id"></div>
                <div class="form-group"><label>Password</label><input type="password" id="login-pass"></div>
                <button class="btn btn-primary" onclick="handleLogin()">Login</button>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <span class="btn-link" onclick="toggleAuth('signup')">Create Account</span>
                    <span class="btn-link" onclick="toggleAuth('forgot')">Forgot Password?</span>
                </div>
                <span class="btn-link" onclick="showScreen('screen-role')"
                    style="display:block; text-align:center; color:#999;">Change Role</span>
            </div>
        </div>

        <div id="signup-form" class="hidden">
            <div class="card">
                <h2>Create Account</h2>
                <div style="text-align:left; max-height:400px; overflow-y:auto; padding-right:5px;">
                    <div class="form-group"><label>First Name</label><input type="text" id="reg-first"></div>
                    <div class="form-group"><label>Last Name</label><input type="text" id="reg-last"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="reg-email"></div>
                    <div class="form-group"><label>Mobile</label><input type="tel" id="reg-mobile"></div>
                    <div class="form-group"><label>User ID</label><input type="text" id="reg-id"></div>
                    <div class="form-group"><label>Password</label><input type="password" id="reg-pass"></div>
                </div>
                <button class="btn btn-accent" onclick="handleSignup()">Register</button>
                <span class="btn-link" onclick="toggleAuth('login')">Back to Login</span>
            </div>
        </div>

        <div id="forgot-form" class="hidden">
            <div class="card">
                <h2>Reset Password</h2>
                <div class="form-group"><label>User ID</label><input type="text" id="forgot-id"></div>
                <div class="form-group"><label>Email</label><input type="email" id="forgot-email"></div>
                <div class="form-group"><label>Mobile</label><input type="tel" id="forgot-mobile"></div>
                <div id="forgot-section-2" class="hidden">
                    <div class="form-group"><label>New Password</label><input type="password" id="forgot-new-pass">
                    </div>
                    <button class="btn btn-accent" onclick="resetPassword()">Set New Password</button>
                </div>
                <button id="btn-verify-forgot" class="btn btn-primary" onclick="verifyForReset()">Verify</button>
                <span class="btn-link" onclick="toggleAuth('login')">Back to Login</span>
            </div>
        </div>
    </div>

    <div id="screen-dashboard" class="hidden"
        style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div class="dash-header">
            <div>
                <h1 style="color:var(--primary); margin:0;">Dashboard</h1>
                <p id="welcome-msg" style="color:#666;"></p>
                <span id="role-badge"
                    style="font-size:0.8rem; padding:2px 8px; border-radius:12px; background:#ddd; color:#333;"></span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#95a5a6; color:white; width:auto; padding:8px 15px;"
                    onclick="showProfileModal()">Update Profile</button>
                <button class="btn" style="background:#e74c3c; color:white; width:auto; padding:8px 15px;"
                    onclick="logout()">Logout</button>
            </div>
        </div>
        

        <div class="dash-grid">
            <a href="Staff.html" class="nav-item" id="nav-staff-card">
                <div class="nav-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                <h3>Teachers and Periods</h3>
                <p>Periods info</p>
            </a>
            <a href="Classes.html" class="nav-item" id="nav-staff-card">
                <div class="nav-icon"><i class="fas fa-graduation-cap"></i></i></div>
                <h3>Classes</h3>
                <p>Class Management</p>
            </a>
            <a href="Students.html" class="nav-item">
                <div class="nav-icon"><i class="fa fa-info-circle"></i></div>
                <h3>Students</h3>
                <p>Student Information</p>
            </a>
            <a href="Result.html" class="nav-item">
                <div class="nav-icon"><i class="fas fa-book-open"></i></div>
                <h3>Result</h3>
                <p>Students Result</p>
            </a>
            <a href="prepare_exam.html" class="nav-item">
                <div class="nav-icon"><i class="fas fa-edit"></i></div>
                <h3>Prepare Exam</h3>
                <p>Set exam papers</p>
            </a>
            <a href="index.html" class="nav-item">
                <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <h3>Paper Tracker</h3>
                <p>Manage checking logs</p>
            </a>
            <a href="calendar.html" class="nav-item">
                <div class="nav-icon"><i class="fa-solid fa-calendar"></i></div>
                <h3>Academic Calendar</h3>
                <p>Program Managing</p>
            </a>
            <a href="Announcement.html" class="nav-item">
                <div class="nav-icon"><i class="fa fa-bullhorn" aria-hidden="true"></i></div>
                <h3>Announcement</h3>
                <p>Announcement Managing</p>
            </a>
            <a href="scholarship.html" class="nav-item">
                <div class="nav-icon"><i class="fas fa-graduation-cap"></i></div>
                <h3>Scholarship</h3>
                <p>Scholarship Managing</p>
            </a>
        </div>

        <button id="btn-show-panel" onclick="toggleAdminPanel(true)"><i class="fas fa-cogs"></i> Show Admin
            Panel</button>

        <div id="admin-panel">
            <div class="panel-section">
                <div class="panel-title">
                    <span><i class="fas fa-clock"></i> Pending Approvals (Official & Individual)</span>
                    <button onclick="toggleAdminPanel(false)"
                        style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;">Hide
                        Panel</button>
                </div>
                <div id="pending-users-list">
                    <p style="color:#999; font-style:italic;">No pending requests.</p>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">
                    <span><i class="fas fa-users"></i> All Registered Users</span>
                    <button onclick="loadAllUsers()"
                        style="background:#3498db; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem;"><i
                            class="fas fa-sync"></i> Refresh</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="user-list-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>User ID</th>
                                <th>Password</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th width="150px">Action</th>
                            </tr>
                        </thead>
                        <tbody id="all-users-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-change-pass" class="modal-overlay">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>Update Profile</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Verify old password to make changes.</p>
            <div class="form-group"><label>Old Password (Required)</label><input type="password" id="cp-old"></div>
            <hr style="margin:15px 0; border:0; border-top:1px dashed #ccc;">
            <div class="form-group"><label>New User ID (Optional)</label><input type="text" id="cp-user"
                    placeholder="Leave empty to keep current"></div>
            <div class="form-group"><label>New Password (Optional)</label><input type="password" id="cp-pass"
                    placeholder="Leave empty to keep current"></div>
            <button class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
            <button class="btn" style="background:#ccc; color:#333;"
                onclick="document.getElementById('modal-change-pass').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="modal-admin-edit" class="modal-overlay">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>Edit User</h3>
            <input type="hidden" id="edit-doc-id">
            <div class="form-group"><label>First Name</label><input type="text" id="edit-first"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="edit-last"></div>
            <div class="form-group"><label>Password</label><input type="text" id="edit-pass"></div>
            <div class="form-group">
                <label>Role</label>
                <select id="edit-role">
                    <option value="official">Official</option>
                    <option value="individual">Individual</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveUserChanges()">Update User</button>
            <button class="btn" style="background:#ccc; color:#333;"
                onclick="document.getElementById('modal-admin-edit').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="auth-footer">Managed by JIIU's Team Department of Modern Education</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDf1R8Tlinug3KZTtDkLp7kvXiqJFnWso",
            authDomain: "exam-system-fa393.firebaseapp.com",
            projectId: "exam-system-fa393",
            storageBucket: "exam-system-fa393.firebasestorage.app",
            messagingSenderId: "640248740140",
            appId: "1:640248740140:web:8dd2fd461051e3cd8fd489",
            measurementId: "G-Y34TY4L3ME"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const usersRef = collection(db, "users");

        let selectedRole = '';
        let currentUserDocId = '';
        let isAdmin = false;

        // --- NAVIGATION ---
        window.showScreen = (id) => {
            ['screen-role', 'screen-code', 'screen-auth', 'screen-dashboard'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.toggleAuth = (form) => {
            ['login-form', 'signup-form', 'forgot-form'].forEach(f => document.getElementById(f).classList.add('hidden'));
            document.getElementById(form + '-form').classList.remove('hidden');
        };

        window.selectRole = (role) => {
            selectedRole = role;
            if (role === 'official') {
                showScreen('screen-code');
            } else {
                showScreen('screen-auth');
                document.getElementById('auth-title').innerText = "Individual Login";
            }
        };

        window.verifyCode = () => {
            const code = document.getElementById('official-code').value;
            if (code === '9960') {
                showScreen('screen-auth');
                document.getElementById('auth-title').innerText = "Official Login";
            } else {
                document.getElementById('code-error').style.display = 'block';
            }
        };

        // --- AUTH LOGIC (SECURE) ---
        window.handleSignup = async () => {
            const first = document.getElementById('reg-first').value.trim();
            const last = document.getElementById('reg-last').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const mobile = document.getElementById('reg-mobile').value.trim();
            const userid = document.getElementById('reg-id').value.trim();
            const pass = document.getElementById('reg-pass').value;

            if (!first || !last || !email || !mobile || !userid || !pass) return alert("Please fill all fields");

            const q = query(usersRef, where("userid", "==", userid));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) return alert("User ID already taken!");

            // FIX: Set status to 'pending' for EVERYONE (Official & Individual)
            const status = 'pending';

            try {
                await addDoc(usersRef, { firstName: first, lastName: last, email, mobile, userid, pass, role: selectedRole, status, createdAt: new Date().toISOString() });
                alert("Account created! Waiting for Admin Approval."); // Unified Message
                toggleAuth('login');
            } catch (e) { alert("Error: " + e.message); }
        };

        window.handleLogin = async () => {
            const userid = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!userid || !pass) return alert("Enter credentials");

            // Hardcoded Admin
            if (userid === "shaikh123") {
                await ensureAdminInDB(userid, pass);
            }

            const q = query(usersRef, where("userid", "==", userid), where("pass", "==", pass));
            const snapshot = await getDocs(q);

            if (snapshot.empty) return alert("Invalid ID or Password");

            const userDoc = snapshot.docs[0];
            const userData = userDoc.data();
            currentUserDocId = userDoc.id;

            // Role Mismatch Check
            if (selectedRole === 'official' && userData.role !== 'official') {
                return alert("Access Denied: This ID is NOT an Official ID.");
            }
            if (selectedRole === 'individual' && userData.role !== 'individual') {
                return alert("Access Denied: Please use the Official Login option.");
            }

            // Approval Check (Applies to everyone now)
            if (userData.status === 'pending') return alert("Your account is pending Admin Approval.");

            // Add access level based on role
            const accessLevel = userData.role === 'official' ? 'full' : 'readonly';
            userData.accessLevel = accessLevel;

            localStorage.setItem('exam_user', JSON.stringify(userData));
            loadDashboard(userData);
        };

        async function ensureAdminInDB(u, p) {
            const q = query(usersRef, where("userid", "==", u));
            const snap = await getDocs(q);
            if (snap.empty) {
                const docRef = await addDoc(usersRef, { firstName: "System", lastName: "Admin", userid: u, pass: p, email: "admin@sys.com", mobile: "000", role: "official", status: "approved", isAdmin: true, createdAt: new Date().toISOString() });
                currentUserDocId = docRef.id;
            } else {
                currentUserDocId = snap.docs[0].id;
                if (!snap.docs[0].data().isAdmin) {
                    await updateDoc(doc(db, "users", currentUserDocId), { isAdmin: true, role: 'official', status: 'approved' });
                }
            }
        }

        function loadDashboard(user) {
            document.body.classList.add('dashboard-active');
            showScreen('screen-dashboard');
            document.getElementById('welcome-msg').innerText = `Welcome, ${user.firstName} ${user.lastName}`;

            // --- FORCE SHOW STAFF CARD FOR EVERYONE ---
            const staffCard = document.getElementById('nav-staff-card');
            if (staffCard) staffCard.style.display = 'block';
            // ------------------------------------------

            const badge = document.getElementById('role-badge');

            if (user.role === 'individual') {
                badge.innerText = 'Individual (Read Only)';
                badge.style.background = '#fef3c7';
                badge.style.color = '#d97706';

                // Hide Admin Tools
                document.getElementById('btn-show-panel').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'none';

            } else {
                badge.innerText = 'Official Access';
                badge.style.background = '#e0e7ff';
                badge.style.color = '#4338ca';

                if (user.userid === 'shaikh123' || user.isAdmin === true) {
                    isAdmin = true;
                    document.getElementById('admin-panel').style.display = 'block';
                    document.getElementById('btn-show-panel').style.display = 'none';
                    loadPendingUsers();
                    loadAllUsers();
                } else {
                    isAdmin = false;
                    document.getElementById('admin-panel').style.display = 'none';
                    document.getElementById('btn-show-panel').style.display = 'none';
                }
            }
        }

        window.toggleAdminPanel = (show) => {
            const panel = document.getElementById('admin-panel');
            const btn = document.getElementById('btn-show-panel');
            if (show) {
                panel.style.display = 'block';
                btn.style.display = 'none';
            } else {
                panel.style.display = 'none';
                btn.style.display = 'block';
            }
        };

        // --- ADMIN PANEL FUNCTIONS ---
        async function loadPendingUsers() {
            const list = document.getElementById('pending-users-list');
            list.innerHTML = 'Loading...';
            // Query strictly for status 'pending' (covers both roles)
            const q = query(usersRef, where("status", "==", "pending"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                list.innerHTML = '<p style="color:#999; font-style:italic;">No pending requests.</p>';
                return;
            }
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const u = doc.data();
                const roleLabel = u.role === 'official' ? '(Official)' : '(Individual)';
                const item = document.createElement('div');
                item.className = 'user-row';
                item.innerHTML = `
                    <div class="user-info">
                        <strong>${u.firstName || ""} ${u.lastName || ""}</strong> 
                        <span style="font-size:0.8rem; color:#666;">${roleLabel}</span><br>
                        <small>ID: ${u.userid} | ${u.email}</small>
                    </div>
                    <button class="btn btn-approve" onclick="approveUser('${doc.id}')">Approve</button>
                `;
                list.appendChild(item);
            });
        }

        async function loadAllUsers() {
            const tbody = document.getElementById('all-users-body');
            tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            const snapshot = await getDocs(usersRef);
            tbody.innerHTML = '';

            snapshot.forEach(doc => {
                const u = doc.data();
                const fullName = (u.firstName || "") + " " + (u.lastName || "");
                let roleBadge = u.role === 'official' ? '<span class="badge-official">Official</span>' : '<span class="badge-individual">Individual</span>';
                if (u.isAdmin) roleBadge += ' <span class="badge-admin">Admin</span>';

                const row = `<tr>
                    <td>${fullName}</td>
                    <td>${u.userid || ""}</td>
                    <td><span class="pass-reveal">${u.pass || ""}</span></td>
                    <td>${roleBadge}</td>
                    <td>${u.status || ""}</td>
                    <td>
                        <button class="action-btn btn-edit" title="Edit" onclick="openAdminEditModal('${doc.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-make-admin" title="Make Admin" onclick="makeUserAdmin('${doc.id}')"><i class="fas fa-crown"></i></button>
                        <button class="action-btn btn-del" title="Delete" onclick="deleteUser('${doc.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        window.approveUser = async (docId) => {
            if (!confirm("Approve this user?")) return;
            await updateDoc(doc(db, "users", docId), { status: 'approved' });
            alert("User Approved!");
            loadPendingUsers();
            loadAllUsers();
        };

        window.makeUserAdmin = async (docId) => {
            if (!confirm("Make this user an Admin?")) return;
            await updateDoc(doc(db, "users", docId), { isAdmin: true, role: 'official', status: 'approved' });
            alert("User is now an Admin!");
            loadAllUsers();
        };

        window.deleteUser = async (docId) => {
            if (!confirm("Are you sure you want to delete this user? This cannot be undone.")) return;
            await deleteDoc(doc(db, "users", docId));
            alert("User deleted.");
            loadAllUsers();
        };

        window.openAdminEditModal = async (docId) => {
            const docSnap = await getDoc(doc(db, "users", docId));
            if (docSnap.exists()) {
                const u = docSnap.data();
                document.getElementById('edit-doc-id').value = docId;
                document.getElementById('edit-first').value = u.firstName || "";
                document.getElementById('edit-last').value = u.lastName || "";
                document.getElementById('edit-pass').value = u.pass || "";
                document.getElementById('edit-role').value = u.role || "individual";
                document.getElementById('modal-admin-edit').style.display = 'flex';
            }
        };

        window.saveUserChanges = async () => {
            const id = document.getElementById('edit-doc-id').value;
            const first = document.getElementById('edit-first').value;
            const last = document.getElementById('edit-last').value;
            const pass = document.getElementById('edit-pass').value;
            const role = document.getElementById('edit-role').value;

            await updateDoc(doc(db, "users", id), { firstName: first, lastName: last, pass: pass, role: role });
            alert("User updated!");
            document.getElementById('modal-admin-edit').style.display = 'none';
            loadAllUsers();
        };

        // --- PROFILE & PASSWORD UPDATE ---
        window.showProfileModal = () => document.getElementById('modal-change-pass').style.display = 'flex';

        window.updateProfile = async () => {
            const oldPass = document.getElementById('cp-old').value;
            const newUser = document.getElementById('cp-user').value.trim();
            const newPass = document.getElementById('cp-pass').value;

            if (!oldPass) return alert("Please enter old password to verify.");
            if (!newUser && !newPass) return alert("Please enter either new User ID or Password.");

            const user = JSON.parse(localStorage.getItem('exam_user'));

            if (!currentUserDocId) {
                const q = query(usersRef, where("userid", "==", user.userid));
                const snap = await getDocs(q);
                if (snap.empty) return alert("User not found in DB.");
                currentUserDocId = snap.docs[0].id;
            }

            const q = query(usersRef, where("userid", "==", user.userid), where("pass", "==", oldPass));
            const snap = await getDocs(q);
            if (snap.empty) return alert("Old password incorrect!");

            const updates = {};
            if (newPass) updates.pass = newPass;
            if (newUser && newUser !== user.userid) {
                const qCheck = query(usersRef, where("userid", "==", newUser));
                const snapCheck = await getDocs(qCheck);
                if (!snapCheck.empty) return alert("New User ID is already taken!");
                updates.userid = newUser;
            }

            await updateDoc(doc(db, "users", currentUserDocId), updates);
            alert("Profile Updated! Please login again.");
            logout();
        };

        // --- FORGOT PASSWORD ---
        window.verifyForReset = async () => {
            const id = document.getElementById('forgot-id').value;
            const email = document.getElementById('forgot-email').value;
            const mobile = document.getElementById('forgot-mobile').value;
            const q = query(usersRef, where("userid", "==", id), where("email", "==", email), where("mobile", "==", mobile));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return alert("Details not found!");
            currentUserDocId = snapshot.docs[0].id;
            document.getElementById('btn-verify-forgot').classList.add('hidden');
            document.getElementById('forgot-section-2').classList.remove('hidden');
        };

        window.resetPassword = async () => {
            const newPass = document.getElementById('forgot-new-pass').value;
            if (!newPass) return alert("Enter new password");
            await updateDoc(doc(db, "users", currentUserDocId), { pass: newPass });
            alert("Password Reset Successfully!");
            toggleAuth('login');
        };

        window.logout = () => {
            localStorage.removeItem('exam_user');
            location.reload();
        };

        const session = localStorage.getItem('exam_user');
        if (session) {
            const user = JSON.parse(session);
            selectedRole = user.role;
            const fetchId = async () => {
                const q = query(usersRef, where("userid", "==", user.userid));
                const snap = await getDocs(q);
                if (!snap.empty) currentUserDocId = snap.docs[0].id;
            }
            fetchId();
            loadDashboard(user);
        }
    </script>
</body>

</html>
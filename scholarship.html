<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholarship Entry System - Dept. of Modern Education</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #2980b9;
            --accent-color: #16a085;
            --result-btn-color: #8e44ad;
            --dashboard-btn-color: #34495e;
            --light-bg: #f4f6f7;
            --border-color: #bdc3c7;
            --delete-color: #e74c3c;
            --edit-color: #f39c12;
            --view-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- MODAL STYLES --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
        }

        .modal-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: var(--primary-color); }
        .modal-btn-container { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-modal { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-modal-ok { background-color: var(--accent-color); }
        .btn-modal-cancel { background-color: var(--delete-color); }
        
        textarea.remarks-box {
            width: 100%; height: 100px; padding: 10px; border: 1px solid var(--secondary-color);
            border-radius: 4px; box-sizing: border-box; resize: none; font-family: inherit;
        }

        .close-modal { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }

        /* --- DASHBOARD BUTTON --- */
        .nav-bar { width: 100%; max-width: 1200px; margin-bottom: 15px; }
        .btn-dashboard {
            background-color: var(--dashboard-btn-color); color: white; text-decoration: none;
            padding: 10px 20px; border-radius: 4px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-dashboard:hover { background-color: #2c3e50; }

        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1200px; margin-bottom: 20px; }

        /* --- FORM SECTION --- */
        .form-card {
            flex: 2; background: white; padding: 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary-color);
        }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .header img { max-width: 100px; margin-bottom: 10px; }
        .header h2 { margin: 0; color: var(--primary-color); text-transform: uppercase; letter-spacing: 1px; }

        .top-actions { display: flex; gap: 15px; margin-bottom: 20px; width: 100%; }
        .btn-action-half {
            flex: 1; padding: 12px; text-align: center; text-decoration: none; color: white;
            border-radius: 5px; font-weight: bold; border: none; cursor: pointer; text-transform: uppercase; font-size: 14px;
        }
        .btn-result { background-color: var(--result-btn-color); }
        .btn-print { background-color: var(--accent-color); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-group.full-width { grid-column: span 2; }
        
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #34495e; font-size: 0.9em; }
        
        input, select { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed; color: #7f8c8d; font-weight: bold; }
        input:not(:read-only) { background-color: #fff; cursor: text; color: #000; }

        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; padding: 5px 0; }
        .radio-group label { font-weight: normal; margin: 0; display: flex; align-items: center; cursor: pointer; }

        .btn-container { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-submit { background-color: var(--secondary-color); color: white; }
        .btn-clear { background-color: #e74c3c; color: white; }

        /* --- SUMMARY SECTION --- */
        .summary-card {
            flex: 1; background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .summary-header { background-color: var(--primary-color); color: white; padding: 10px; text-align: center; border-radius: 4px 4px 0 0; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .stat-row:last-child { border-bottom: none; background-color: #e8f6f3; font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-top: 10px; border-radius: 4px; }

        /* --- RECORDS TABLE --- */
        .records-container { width: 100%; max-width: 1200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
        .records-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--secondary-color); padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .tools-bar { display: flex; gap: 10px; flex-wrap: wrap; }
        .search-box { padding: 8px; border: 2px solid var(--secondary-color); border-radius: 4px; width: 250px; outline: none; }
        .btn-excel { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .btn-export { background-color: #27ae60; }
        .btn-import { background-color: #d35400; position: relative; overflow: hidden; }
        #importFile { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; }
        table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        table th { background-color: var(--secondary-color); color: white; }
        table tr:hover { background-color: #f1f1f1; }
        
        .action-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px; color: white; font-size: 12px; }
        .btn-edit { background-color: var(--edit-color); }
        .btn-delete { background-color: var(--delete-color); }
        .btn-view { background-color: var(--view-color); }

        /* --- RECEIPT PRINT STYLES --- */
        #receipt-area { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; padding: 0; }
            body > * { display: none !important; }
            
            #receipt-area {
                display: block !important;
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: white; padding: 15mm; box-sizing: border-box;
                font-family: 'Times New Roman', serif; color: #000; z-index: 9999;
            }

            #receipt-area::before {
                content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                width: 60%; height: 60%; background-image: url('ME PNG.png');
                background-repeat: no-repeat; background-position: center; background-size: contain;
                opacity: 0.08; z-index: -1;
            }

            .r-header-container {
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 30px; width: 100%;
            }
            .r-header-text { flex: 1; text-align: center; padding-left: 35mm; }
            .r-header-text h1 { margin: 0; font-size: 34px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
            .r-header-text h3 { margin: 5px 0 0 0; font-size: 22px; font-style: italic; font-weight: normal; }

            .r-photo-box {
                width: 35mm; height: 45mm; border: 2px solid #000;
                display: flex; align-items: center; justify-content: center;
                font-size: 12px; color: #555; background: #fdfdfd; text-align: center;
            }

            .receipt-body {
                display: grid; grid-template-columns: 1fr 1fr; column-gap: 20mm; row-gap: 15mm;
                font-size: 18px; width: 100%; margin-top: 30px;
            }
            .receipt-item { display: flex; flex-direction: column; border-bottom: 1px dotted #888; padding-bottom: 5px; }
            .receipt-item strong { font-size: 15px; color: #444; text-transform: uppercase; margin-bottom: 8px; }
            .receipt-item span { font-size: 22px; font-weight: bold; color: #000; padding-left: 5px; }
            .full-row { grid-column: span 2; }

            .receipt-footer { position: absolute; bottom: 25mm; right: 20mm; text-align: center; }
            .receipt-footer .line { width: 250px; border-top: 2px solid #000; margin-bottom: 10px; }
            .receipt-footer p { margin: 0; font-size: 18px; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="nav-bar">
    <a href="Dashboard.html" class="btn-dashboard">‚¨Ö Go to Dashboard</a>
</div>

<div class="main-container">
    
    <div class="form-card">
        <div class="header">
            <img src="ME PNG.png" alt="Dept Logo" onerror="this.style.display='none'">
            <h2>Scholarship Entry Form</h2>
        </div>

        <div class="top-actions">
            <a href="Result.html" class="btn-action-half btn-result" target="_blank">üìÑ Go to Result Page</a>
            <button type="button" class="btn-action-half btn-print" onclick="printReceipt()">üñ® Print Receipt</button>
        </div>

        <form id="scholarshipForm">
            <input type="hidden" id="editDocId">

            <div class="form-grid">
                
                <div class="form-group">
                    <label>GR No <span style="color:red">*</span></label>
                    <input type="number" id="grNo" placeholder="Enter GR No" required>
                </div>

                <div class="form-group">
                    <label>Date <span style="color:red">*</span></label>
                    <input type="date" id="entryDate" required>
                </div>

                <div class="form-group full-width">
                    <label>Name of Student</label>
                    <input type="text" id="studentName" readonly placeholder="Auto-fetched...">
                </div>

                <div class="form-group">
                    <label>Class</label>
                    <input type="text" id="studentClass" readonly placeholder="Auto-fetched...">
                </div>

                <div class="form-group">
                    <label>Division</label>
                    <input type="text" id="division" readonly placeholder="Auto-fetched (e.g. Alif/Ba)...">
                </div>

                <div class="form-group">
                    <label>Percentage</label>
                    <input type="text" id="percentage" readonly placeholder="Auto-fetched...">
                </div>

                <div class="form-group full-width">
                    <label>Exam Type</label>
                    <div class="radio-group" id="examTypeGroup">
                        <label><input type="radio" name="examType" value="First Semester" checked> First Semester</label>
                        <label><input type="radio" name="examType" value="Second Semester"> Second Semester</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Course (Applied For)</label>
                    <select id="courseSelect" required>
                        <option value="10th">10th</option>
                        <option value="12th">12th</option>
                        <option value="BA 1st">BA 1st</option>
                        <option value="BA 2nd">BA 2nd</option>
                        <option value="BA 3rd">BA 3rd</option>
                        <option value="MA 1st">MA 1st</option>
                        <option value="MA 2nd">MA 2nd</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label>Board</label>
                    <div class="radio-group">
                        <label><input type="radio" name="board" value="NIOS" checked> NIOS</label>
                        <label><input type="radio" name="board" value="TNB"> TNB</label>
                        <label><input type="radio" name="board" value="YRC"> YRC</label>
                        <label><input type="radio" name="board" value="UEB"> UEB</label>
                        <label><input type="radio" name="board" value="MANU"> MANU</label>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Reference Person</label>
                    <div class="radio-group">
                        <label><input type="radio" name="refPerson" value="Boss"> Boss</label>
                        <label><input type="radio" name="refPerson" value="Saeed" checked> Saeed</label>
                        <label><input type="radio" name="refPerson" value="Hassan"> Hassan</label>
                        <label><input type="radio" name="refPerson" value="Iqrar"> Iqrar</label>
                        <label><input type="radio" name="refPerson" value="Tahir"> Tahir</label>
                        <label><input type="radio" name="refPerson" value="Abdullah"> Abdullah</label>
                        <label><input type="radio" name="refPerson" value="Faizan"> Faizan</label>
                    </div>
                </div>

            </div>

            <div class="btn-container">
                <button type="button" class="btn btn-clear" onclick="clearForm()">Clear / Cancel</button>
                <button type="submit" class="btn btn-submit" id="submitBtn">Submit Entry</button>
            </div>
        </form>
    </div>

    <div class="summary-card">
        <div class="summary-header">Live Statistics</div>
        <div class="stat-row"><span>10th Approved:</span><span id="count-10th">0</span></div>
        <div class="stat-row"><span>12th Approved:</span><span id="count-12th">0</span></div>
        <div class="stat-row"><span>BA Approved:</span><span id="count-ba">0</span></div>
        <div class="stat-row"><span>MA Approved:</span><span id="count-ma">0</span></div>
        <div class="stat-row" style="margin-top:20px; border-top: 2px solid #ccc;"><span>TOTAL FORMS:</span><span id="count-total">0</span></div>
    </div>
</div>

<div class="records-container">
    <div class="records-header">
        <h3>Saved Scholarship Records</h3>
        <div class="tools-bar">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Search...">
            <button onclick="exportToExcel()" class="btn-excel btn-export">üì• Export Excel</button>
            <button class="btn-excel btn-import">üì§ Import Excel<input type="file" id="importFile" accept=".xlsx, .xls"></button>
        </div>
    </div>

    <table id="recordsTable">
        <thead>
            <tr>
                <th style="width: 40px;">Sr</th>
                <th>GR No</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Division</th> <th>Percentage</th>
                <th>Course</th>
                <th>Exam Type</th>
                <th>Date</th>
                <th>Ref</th>
                <th>Remark</th>
                <th style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody id="recordsBody">
            </tbody>
    </table>
</div>

<div id="duplicateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">‚ö†Ô∏è Duplicate Entry Detected!</div>
        <p>This Student (GR No & Course) already exists.</p>
        <p>Do you want to add <b>Remarks</b> and proceed?</p>
        <div class="modal-btn-container">
            <button class="btn-modal btn-modal-ok" onclick="openRemarksInput()">Ok (Agree)</button>
            <button class="btn-modal btn-modal-cancel" onclick="closeDuplicateModal()">Cancel (Reject)</button>
        </div>
    </div>
</div>

<div id="remarksInputModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">üìù Enter Remarks</div>
        <p>Please provide a reason for this duplicate entry:</p>
        <textarea id="remarksText" class="remarks-box" placeholder="Write remarks here..."></textarea>
        <div class="modal-btn-container">
            <button class="btn-modal btn-modal-ok" onclick="submitWithRemarks()">Submit Entry</button>
            <button class="btn-modal btn-modal-cancel" onclick="closeRemarksInput()">Cancel</button>
        </div>
    </div>
</div>

<div id="viewRemarksModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeViewRemarks()">&times;</span>
        <div class="modal-header">üëÅ Remarks Detail</div>
        <p id="viewRemarksText" style="text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px; color: #333;">
        </p>
    </div>
</div>


<div id="receipt-area">
    <div class="r-header-container">
        <div class="r-header-text">
            <h1>Dept. of Modern Education</h1>
            <h3>Scholarship Acknowledgement Receipt</h3>
        </div>
        <div class="r-photo-box">Paste<br>Photo<br>Here</div>
    </div>

    <div class="receipt-body">
        <div class="receipt-item">
            <strong>GR No:</strong> <span id="r-gr"></span>
        </div>
        <div class="receipt-item">
            <strong>Date:</strong> <span id="r-date"></span>
        </div>
        <div class="receipt-item full-row">
            <strong>Name of Student:</strong> <span id="r-name"></span>
        </div>
        <div class="receipt-item">
            <strong>Class:</strong> <span id="r-class"></span>
        </div>
        <div class="receipt-item">
            <strong>Division:</strong> <span id="r-division"></span>
        </div>
        <div class="receipt-item">
            <strong>Percentage:</strong> <span id="r-percent"></span>
        </div>
        <div class="receipt-item">
            <strong>Course (Applied):</strong> <span id="r-course"></span>
        </div>
        <div class="receipt-item">
            <strong>Exam Type:</strong> <span id="r-type"></span>
        </div>
        <div class="receipt-item">
            <strong>Board:</strong> <span id="r-board"></span>
        </div>
        <div class="receipt-item">
            <strong>Reference Person:</strong> <span id="r-ref"></span>
        </div>
    </div>

    <div class="receipt-footer">
        <div class="line"></div>
        <p>Authorized Signature</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASGq5vy-VTF3OI44l5txmwKoQCcOM3DNg",
      authDomain: "scholarship-75a96.firebaseapp.com",
      projectId: "scholarship-75a96",
      storageBucket: "scholarship-75a96.firebasestorage.app",
      messagingSenderId: "230303480430",
      appId: "1:230303480430:web:f6df98cc3a28e31287447f",
      measurementId: "G-YBCN3S95D1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    window.allScholarships = [];
    let pendingFormData = null;

    // --- SUBMIT / UPDATE FORM ---
    document.getElementById('scholarshipForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const editId = document.getElementById('editDocId').value;
        
        const formData = {
            grNo: document.getElementById('grNo').value,
            name: document.getElementById('studentName').value,
            class: document.getElementById('studentClass').value,
            division: document.getElementById('division').value,
            percent: document.getElementById('percentage').value,
            date: document.getElementById('entryDate').value,
            examType: document.querySelector('input[name="examType"]:checked').value,
            course: document.getElementById('courseSelect').value,
            board: document.querySelector('input[name="board"]:checked').value,
            ref: document.querySelector('input[name="refPerson"]:checked').value,
            timestamp: new Date(),
            remarks: ""
        };

        if(!formData.name) { alert("Invalid Entry! Please check GR No."); return; }

        // --- DUPLICATE CHECK ---
        const isDuplicate = window.allScholarships.some(r => 
            r.grNo == formData.grNo && 
            r.course == formData.course && 
            r.id !== editId
        );

        if (isDuplicate) {
            pendingFormData = formData; 
            document.getElementById('duplicateModal').style.display = "block";
            return;
        }

        await saveRecord(formData, editId);
    });

    async function saveRecord(data, editId) {
        try {
            if (editId) {
                await updateDoc(doc(db, "scholarships", editId), data);
                alert("Record Updated Successfully!");
                clearForm();
            } else {
                await addDoc(collection(db, "scholarships"), data);
                alert("Entry Saved Successfully!");
                updatePrintReceipt(data);
            }
        } catch (error) {
            console.error("Error: ", error);
        }
    }

    // --- MODAL LOGIC ---
    window.closeDuplicateModal = () => {
        document.getElementById('duplicateModal').style.display = "none";
        pendingFormData = null;
    }

    window.openRemarksInput = () => {
        document.getElementById('duplicateModal').style.display = "none";
        document.getElementById('remarksInputModal').style.display = "block";
        document.getElementById('remarksText').value = "";
    }

    window.submitWithRemarks = async () => {
        const remarks = document.getElementById('remarksText').value;
        if(!remarks.trim()) {
            alert("Please enter some remarks.");
            return;
        }
        
        pendingFormData.remarks = remarks;
        const editId = document.getElementById('editDocId').value;
        
        await saveRecord(pendingFormData, editId);
        
        document.getElementById('remarksInputModal').style.display = "none";
        pendingFormData = null;
    }

    window.closeRemarksInput = () => {
        document.getElementById('remarksInputModal').style.display = "none";
        pendingFormData = null;
    }

    window.viewRemarks = (id) => {
        const record = window.allScholarships.find(r => r.id === id);
        const text = (record && record.remarks) ? record.remarks : "No Remarks found.";
        document.getElementById('viewRemarksText').innerText = text;
        document.getElementById('viewRemarksModal').style.display = "block";
    }

    window.closeViewRemarks = () => {
        document.getElementById('viewRemarksModal').style.display = "none";
    }


    // --- LIVE TABLE & STATS ---
    const q = query(collection(db, "scholarships"), orderBy("timestamp", "desc"));
    
    onSnapshot(q, (snapshot) => {
        let stats = { "10th": 0, "12th": 0, "BA": 0, "MA": 0, "Total": 0 };
        let tableHTML = "";
        let index = 1;
        
        window.allScholarships = [];

        snapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();
            const id = docSnapshot.id;
            
            window.allScholarships.push({ id, ...data });
            
            const c = data.course || "";
            stats.Total++;
            if(c.includes("10th")) stats["10th"]++;
            else if(c.includes("12th")) stats["12th"]++;
            else if(c.includes("BA")) stats["BA"]++;
            else if(c.includes("MA")) stats["MA"]++;

            tableHTML += `
                <tr>
                    <td>${index++}</td>
                    <td>${data.grNo}</td>
                    <td>${data.name}</td>
                    <td>${data.class}</td>
                    <td>${data.division || "-"}</td> 
                    <td>${data.percent}</td>
                    <td>${data.course}</td>
                    <td>${data.examType}</td>
                    <td>${data.date}</td>
                    <td>${data.ref}</td>
                    <td>${data.remarks || "-"}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewRemarks('${id}')" title="View Remarks">üëÅ</button>
                        <button class="action-btn btn-edit" onclick="editRecord('${id}', '${data.grNo}', '${data.date}', '${data.examType}', '${data.course}', '${data.board}', '${data.ref}')">‚úé</button>
                        <button class="action-btn btn-delete" onclick="deleteRecord('${id}')">‚úñ</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('count-10th').innerText = stats["10th"];
        document.getElementById('count-12th').innerText = stats["12th"];
        document.getElementById('count-ba').innerText = stats["BA"];
        document.getElementById('count-ma').innerText = stats["MA"];
        document.getElementById('count-total').innerText = stats["Total"];
        document.getElementById('recordsBody').innerHTML = tableHTML;
    });

    window.deleteRecord = async (id) => {
        if(confirm("Are you sure you want to delete this record?")) {
            await deleteDoc(doc(db, "scholarships", id));
        }
    }

    // --- EDIT RECORD FUNCTION ---
    window.editRecord = (id, gr, date, examType, course, board, ref) => {
        document.getElementById('editDocId').value = id;
        document.getElementById('submitBtn').innerText = "Update Record";
        document.getElementById('submitBtn').style.backgroundColor = "#f39c12";

        document.getElementById('grNo').value = gr;
        document.getElementById('entryDate').value = date;
        document.getElementById('courseSelect').value = course;

        document.querySelector(`input[name="examType"][value="${examType}"]`).checked = true;
        document.querySelector(`input[name="board"][value="${board}"]`).checked = true;
        document.querySelector(`input[name="refPerson"][value="${ref}"]`).checked = true;

        fetchStudentData(); 
        window.scrollTo(0,0);
    }
</script>

<script>
    function fetchStudentData() {
        const gr = document.getElementById('grNo').value;
        const nameField = document.getElementById('studentName');
        const classField = document.getElementById('studentClass');
        const divisionField = document.getElementById('division');
        const percentField = document.getElementById('percentage');

        if (!gr) {
            nameField.value = ""; classField.value = ""; divisionField.value = ""; percentField.value = "";
            return;
        }

        // FETCH DATA
        const storedData = localStorage.getItem('resultData_v4');
        let foundStudent = null;

        if (storedData) {
            const allData = JSON.parse(storedData);
            
            // Key is "ClassName_SectionName" (e.g. "Arabi Awal_Alif")
            for (const key in allData) {
                const sectionData = allData[key];
                if (sectionData.students && Array.isArray(sectionData.students)) {
                    const s = sectionData.students.find(std => std.gr == gr);
                    if (s) {
                        // === Extract Section (Div) from the Key ===
                        let splitKey = key.split('_'); 
                        let actualClass = splitKey[0]; 
                        let actualSection = splitKey[1] || ""; // This is 'Alif', 'Ba', etc.

                        foundStudent = {
                            name: s.name,
                            class: s.class || actualClass,
                            division: actualSection, // Use the extracted Section Name
                            percent: s.percent
                        };
                        break;
                    }
                }
            }
        }

        if (foundStudent) {
            nameField.value = foundStudent.name;
            classField.value = foundStudent.class;
            divisionField.value = foundStudent.division; // Populates Alif, Ba, etc.
            
            let p = foundStudent.percent;
            if (typeof p === 'number') {
                percentField.value = p.toFixed(2) + "%";
            } else {
                percentField.value = p;
            }
        } else {
            nameField.value = "";
            classField.value = "";
            divisionField.value = "";
            percentField.value = "";
        }
    }

    // Auto-Set Date & Fetch Data on GR Input
    document.getElementById('grNo').addEventListener('input', function() {
        if(this.value.length > 0) {
            document.getElementById('entryDate').valueAsDate = new Date();
        }
        fetchStudentData();
    });

    document.getElementById('entryDate').valueAsDate = new Date();

    function clearForm() {
        document.getElementById('scholarshipForm').reset();
        document.getElementById('editDocId').value = "";
        document.getElementById('submitBtn').innerText = "Submit Entry";
        document.getElementById('submitBtn').style.backgroundColor = "";
        document.getElementById('entryDate').valueAsDate = new Date();
    }

    function updatePrintReceipt(data) {
        document.getElementById('r-date').innerText = data.date || document.getElementById('entryDate').value;
        document.getElementById('r-gr').innerText = data.grNo || document.getElementById('grNo').value;
        document.getElementById('r-name').innerText = data.name || document.getElementById('studentName').value;
        document.getElementById('r-class').innerText = data.class || document.getElementById('studentClass').value;
        document.getElementById('r-division').innerText = data.division || document.getElementById('division').value;
        document.getElementById('r-percent').innerText = data.percent || document.getElementById('percentage').value;
        document.getElementById('r-course').innerText = data.course || document.getElementById('courseSelect').value;
        document.getElementById('r-type').innerText = data.examType || document.querySelector('input[name="examType"]:checked').value;
        document.getElementById('r-board').innerText = data.board || document.querySelector('input[name="board"]:checked').value;
        document.getElementById('r-ref').innerText = data.ref || document.querySelector('input[name="refPerson"]:checked').value;
    }

    function printReceipt() {
        const currentData = {
            date: document.getElementById('entryDate').value,
            grNo: document.getElementById('grNo').value,
            name: document.getElementById('studentName').value,
            class: document.getElementById('studentClass').value,
            division: document.getElementById('division').value,
            percent: document.getElementById('percentage').value,
            course: document.getElementById('courseSelect').value,
            examType: document.querySelector('input[name="examType"]:checked').value,
            board: document.querySelector('input[name="board"]:checked').value,
            ref: document.querySelector('input[name="refPerson"]:checked').value
        };
        
        if(!currentData.name) { alert("Cannot print empty receipt."); return; }
        updatePrintReceipt(currentData);
        window.print();
    }

    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toUpperCase();
        let rows = document.getElementById('recordsBody').getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            let text = rows[i].innerText.toUpperCase();
            rows[i].style.display = text.includes(filter) ? "" : "none";
        }
    });

    window.exportToExcel = function() {
        let table = document.getElementById("recordsTable");
        let clone = table.cloneNode(true);
        let rows = clone.getElementsByTagName('tr');
        for(let row of rows) {
            if(row.cells.length > 0) row.deleteCell(-1);
        }
        let wb = XLSX.utils.table_to_book(clone, {sheet: "Scholarships"});
        XLSX.writeFile(wb, "Scholarship_Data.xlsx");
    }
</script>

</body>
</html>